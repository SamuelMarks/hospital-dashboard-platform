<div class="scenario-layout">
  
  <div class="config-pane mat-elevation-z2">
    <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
      <mat-icon class="text-primary">tune</mat-icon> 
      Configuration
    </h2>

    <div class="section">
      <h3 class="section-title">Unit Capacities (Beds)</h3>
      <div class="capacity-list">
        @for (unit of units(); track unit) { 
          <div class="capacity-row">
            <span class="unit-label">{{ unit }}</span>
            <div class="slider-group">
              <mat-slider min="0" max="50" step="1" discrete showTickMarks>
                <input matSliderThumb [value]="getCapacity(unit)" (valueChange)="setCapacity(unit, $event)">
              </mat-slider>
              <span class="val-badge">{{ getCapacity(unit) }}</span>
            </div>
          </div>
        } 
      </div>
    </div>

    <div class="section mt-6">
      <h3 class="section-title">Demand Source</h3>
      <mat-form-field appearance="outline" class="w-full text-xs">
        <mat-label>SQL Query</mat-label>
        <textarea matInput [value]="store.demandSql()" rows="4" readonly class="font-mono text-gray-500"></textarea>
        <mat-hint>Include 'Unit' column for Delta calculation.</mat-hint>
      </mat-form-field>
    </div>

    <div class="action-footer mt-auto pt-4">
      <button 
        mat-flat-button 
        color="accent" 
        class="w-full h-12 text-lg" 
        (click)="store.runScenario()" 
        [disabled]="store.isRunning()" 
      >
        @if (store.isRunning()) { 
          <div class="flex items-center justify-center">
            <mat-spinner diameter="24" class="mr-2"></mat-spinner> Simulating... 
          </div>
        } @else { 
          <ng-container>
            <mat-icon>play_circle</mat-icon> Run Simulation
          </ng-container>
        } 
      </button>
    </div>
  </div>

  <div class="results-pane p-6 overflow-y-auto">
    <div class="flex justify-between items-end mb-4">
      <div>
        <h1 class="text-2xl font-light">Scenario Results</h1>
        <p class="text-gray-500 text-sm">Optimization based on current input parameters.</p>
      </div>
      @if (store.results()) { 
        <div class="kpi-badge">
          Allocated: <strong>{{ totalAllocated() }}</strong> Patients
        </div>
      } 
    </div>

    @if (store.error()) { 
      <div class="p-4 bg-red-50 text-red-700 border-l-4 border-red-500 rounded mb-4">
        <strong>Simulation Error:</strong> {{ store.error() }} 
      </div>
    } 

    @if (!store.results() && !store.isRunning()) { 
      <div class="empty-state">
        <mat-icon class="text-6xl text-gray-300 mb-4">analytics</mat-icon>
        <p>Adjust parameters and click Run to see optimization results.</p>
      </div>
    } 
    
    @else if (store.isRunning()) { 
      <div class="empty-state">
        <mat-spinner diameter="50"></mat-spinner>
        <p class="mt-4 text-gray-500">Processing Optimization Model...</p>
      </div>
    } 
    
    @else { 
      <!-- Charts Row -->
      <div class="grid grid-cols-2 gap-4 mb-4" style="min-height: 250px;">
        <div class="viz-wrapper mat-elevation-z1 p-2">
           <h4 class="text-xs font-bold uppercase text-gray-400 mb-1 ml-2">Recommended Allocation</h4>
           <viz-chart [dataSet]="allocationData()" [config]="{stackBy:'Service', xKey: 'Unit', yKey: 'Patients'}"></viz-chart>
        </div>
        
        <div class="viz-wrapper mat-elevation-z1 p-2">
           <h4 class="text-xs font-bold uppercase text-gray-400 mb-1 ml-2">Net Deviation (Proposed - Current)</h4>
           <viz-chart [dataSet]="deviationData()" [config]="{xKey: 'Unit', yKey: 'Delta', stackBy:'Service'}"></viz-chart>
        </div>
      </div>

      <!-- Detail Table -->
      <div class="viz-wrapper mat-elevation-z1 flex-grow" style="min-height: 300px;">
        <h4 class="text-xs font-bold uppercase text-gray-400 p-3 bg-gray-50 border-b">Detailed Assignments</h4>
        <viz-table [dataSet]="tableData()" class="h-full block w-full"></viz-table>
      </div>
    } 
  </div>

</div>