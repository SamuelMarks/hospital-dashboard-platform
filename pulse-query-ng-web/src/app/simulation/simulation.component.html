<div class="mb-6 flex justify-between items-center">
  <div>
    <h1 class="text-2xl font-light mb-1">Workload Simulation</h1>
    <p class="text-gray-500">
      Generate synthetic traffic patterns to test dashboard responsiveness.
    </p>
  </div>

  <div class="flex gap-2">
    <button mat-flat-button color="primary" (click)="store.toggleSimulation()">
      <mat-icon>{{ store.isActive() ? 'stop' : 'play_arrow' }}</mat-icon>
      {{ store.isActive() ? 'Stop Simulation' : 'Start Simulation' }}
    </button>
  </div>
</div>

<div class="grid-layout">
  <!-- Left: Controls -->
  <mat-card class="control-panel p-6">
    <h3 class="font-medium text-lg mb-4">Parameters</h3>

    <!-- Concurrent Users Slider -->
    <div class="slider-group">
      <div class="slider-header">
        <span>Concurrent Users</span>
        <span class="font-bold text-primary">{{ params().users }}</span>
      </div>
      <!-- A11y: Labeled Slider -->
      <mat-slider min="0" max="1000" step="10" discrete>
        <input
          matSliderThumb
          [ngModel]="params().users"
          (ngModelChange)="updateParam('users', $event)"
          aria-label="Concurrent Users Slider"
        />
      </mat-slider>
    </div>

    <!-- Request Rate Slider -->
    <div class="slider-group">
      <div class="slider-header">
        <span>Request Rate (req/sec)</span>
        <span class="font-bold text-primary">{{ params().rate }}</span>
      </div>
      <mat-slider min="1" max="500" step="5" discrete>
        <input
          matSliderThumb
          [ngModel]="params().rate"
          (ngModelChange)="updateParam('rate', $event)"
          aria-label="Request Rate Slider"
        />
      </mat-slider>
    </div>

    <mat-divider></mat-divider>

    <!-- Error Injection Toggle -->
    <div class="flex justify-between items-center py-2">
      <span class="text-sm font-medium">Inject Random Errors</span>
      <mat-slide-toggle
        [ngModel]="params().errorInjection"
        (ngModelChange)="updateParam('errorInjection', $event)"
        color="warn"
        aria-label="Toggle Error Injection"
      ></mat-slide-toggle>
    </div>

    @if (params().errorInjection) {
      <div class="slider-group pl-4 border-l-2 border-red-100">
        <div class="slider-header text-red-800">
          <span>Failure Rate</span>
          <span>{{ params().failureRate }}%</span>
        </div>
        <mat-slider min="0" max="100" step="1">
          <input
            matSliderThumb
            [ngModel]="params().failureRate"
            (ngModelChange)="updateParam('failureRate', $event)"
            aria-label="Failure Rate Percentage"
          />
        </mat-slider>
      </div>
    }

    <!-- Latency Injection -->
    <div class="flex justify-between items-center py-2">
      <span class="text-sm font-medium">Simulate Network Latency</span>
      <mat-slide-toggle
        [ngModel]="params().latencyInjection"
        (ngModelChange)="updateParam('latencyInjection', $event)"
        color="accent"
        aria-label="Toggle Latency Injection"
      ></mat-slide-toggle>
    </div>
  </mat-card>

  <!-- Right: Real-time Stats -->
  <div class="flex flex-col gap-4">
    <!-- Status Banner -->
    <div class="status-panel">
      <div class="flex items-center gap-2 mb-4">
        <div
          class="w-3 h-3 rounded-full"
          [class.bg-green-500]="store.isActive()"
          [class.bg-gray-300]="!store.isActive()"
        ></div>
        <span class="font-bold text-sm uppercase">{{ store.isActive() ? 'Running' : 'Idle' }}</span>
      </div>

      <div class="metrics-grid">
        <div class="metric-item">
          <div class="metric-val text-blue-600">{{ metrics().activeConnections }}</div>
          <div class="metric-lbl">Active Conn</div>
        </div>
        <div class="metric-item">
          <div class="metric-val text-purple-600">{{ metrics().rps | number: '1.0-0' }}</div>
          <div class="metric-lbl">Req / Sec</div>
        </div>
        <div class="metric-item">
          <div class="metric-val text-red-600">{{ metrics().errorCount }}</div>
          <div class="metric-lbl">Total Errors</div>
        </div>
        <div class="metric-item">
          <div class="metric-val text-amber-600">
            {{ metrics().avgLatency | number: '1.0-0' }}ms
          </div>
          <div class="metric-lbl">Avg Latency</div>
        </div>
      </div>
    </div>

    <!-- Live Chart -->
    <mat-card class="flex-grow min-h-[300px] p-4 flex flex-col">
      <h4 class="text-xs font-bold uppercase text-gray-400 mb-2">
        Throughput History (Last 1 min)
      </h4>
      <div class="flex-grow relative">
        <viz-chart
          [dataSet]="chartData()"
          [config]="chartConfig"
          class="absolute inset-0"
        ></viz-chart>
      </div>
    </mat-card>
  </div>
</div>
