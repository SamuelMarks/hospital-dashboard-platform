<div class="message-list" #scrollContainer>
  <!-- Empty State -->
  @if (store.messages().length === 0 && !store.isGenerating()) {
    <div class="empty-state-wrapper">
      <mat-icon class="icon-hero">assistant</mat-icon>
      <h2>Data Assistant</h2>
      <p>Ask questions about hospital census, throughput, or capacity.</p>
    </div>
  }

  @for (msg of store.messages(); track msg.id) {
    <div class="message-row" [ngClass]="msg.role">
      <mat-card class="message-bubble" [class.user-bubble]="msg.role === 'user'">
        <mat-card-content>
          <!-- A: Voting Mode -->
          @if (hasPendingCandidates(msg)) {
            <div class="arena-header">
              <span class="mat-label-small"> Compare {{ msg.candidates?.length }} Models </span>
              @if (hasSqlCandidates(msg)) {
                <button mat-button color="accent" (click)="runAllCandidates(msg)">
                  <mat-icon>play_arrow</mat-icon> Run All
                </button>
              }
            </div>

            <div class="candidates-grid">
              @for (cand of msg.candidates; track cand.id) {
                <div class="candidate-item mat-elevation-z2">
                  <div class="candidate-meta">
                    <span class="model-tag">{{ cand.model_name }}</span>
                    @if (sqlGroupCount(msg, cand) > 1) {
                      <span class="group-badge">
                        Matches {{ sqlGroupCount(msg, cand) - 1 }} others
                      </span>
                    }
                  </div>

                  <div class="candidate-body">
                    @if (candidateError(cand.id)) {
                      <div class="error-container">
                        <mat-icon color="warn" class="icon-small">warning</mat-icon>
                        <span>{{ candidateError(cand.id) }}</span>
                      </div>
                    }

                    <viz-markdown [content]="cleanContentSimple(cand.content)"></viz-markdown>

                    @if (cand.sql_snippet) {
                      <app-sql-snippet
                        class="mt-2"
                        [sql]="cand.sql_snippet"
                        (run)="runCandidateQuery(cand)"
                        (addToCart)="saveToCart(cand.sql_snippet)"
                      ></app-sql-snippet>
                    }

                    @if (isCandidateLoading(cand.id)) {
                      <mat-progress-bar mode="indeterminate"></mat-progress-bar>
                    }

                    <!-- RE-ADDED: VizTable Preview (Fixes NG8113) -->
                    @if (candidateResult(cand.id)) {
                      <div class="table-preview mat-elevation-z1">
                        <viz-table [dataSet]="candidateResult(cand.id)"></viz-table>
                      </div>
                    }
                  </div>

                  <div class="candidate-actions">
                    <button
                      mat-flat-button
                      color="primary"
                      class="w-full"
                      (click)="vote(msg.id, cand.id)"
                    >
                      Select Model
                    </button>
                  </div>
                </div>
              }
            </div>
          }
          <!-- B: Standard Message -->
          @else {
            <viz-markdown [content]="cleanContent(msg)"></viz-markdown>
            @if (msg.sql_snippet) {
              <app-sql-snippet
                [sql]="msg.sql_snippet"
                (run)="runQuery($event)"
                (addToCart)="saveToCart($event)"
              ></app-sql-snippet>
            }
          }
        </mat-card-content>
        <mat-card-footer class="message-footer">
          {{ msg.created_at | date: 'shortTime' }}
        </mat-card-footer>
      </mat-card>
    </div>
  }

  @if (store.isGenerating()) {
    <div class="message-row assistant">
      <mat-card class="message-bubble loading-bubble">
        <mat-progress-spinner mode="indeterminate" diameter="24"></mat-progress-spinner>
      </mat-card>
    </div>
  }

  @if (store.error(); as err) {
    <div class="global-error-toast mat-elevation-z4">
      <mat-icon color="warn">error</mat-icon>
      <span>{{ err }}</span>
    </div>
  }
</div>

<div class="composer-container mat-elevation-z4">
  <!-- Model Selection Chips -->
  <div class="model-selector" *ngIf="store.availableModels().length > 0">
    <mat-chip-listbox multiple aria-label="Select Models to Query">
      @for (model of store.availableModels(); track model.id) {
        <mat-chip-option
          [selected]="store.selectedModelIds().includes(model.id)"
          (click)="store.toggleModelSelection(model.id)"
          [matTooltip]="model.name"
        >
          {{ model.name }}
        </mat-chip-option>
      }
    </mat-chip-listbox>
  </div>

  <mat-form-field appearance="outline" subscriptSizing="dynamic" class="w-full">
    <textarea
      matInput
      placeholder="Ask about hospital data..."
      [(ngModel)]="inputText"
      (keydown.enter)="handleEnter($event)"
      cdkTextareaAutosize
      cdkAutosizeMinRows="1"
      cdkAutosizeMaxRows="5"
      [disabled]="store.isGenerating()"
    ></textarea>
    <button
      mat-icon-button
      matSuffix
      color="primary"
      (click)="send()"
      [disabled]="!inputText.trim() || store.isGenerating()"
      aria-label="Send Message"
    >
      <mat-icon>send</mat-icon>
    </button>
  </mat-form-field>
</div>
