<!-- Toolbar & Ribbons -->
@if (!isTvMode()) { 
  <app-toolbar></app-toolbar>
  <app-filter-ribbon></app-filter-ribbon>
} @else { 
  <div class="tv-carousel-header">
    <div class="tv-dashboard-title">{{ store.dashboard()?.name }}</div>
    <div class="tv-meta">
      @if (store.lastUpdated(); as date) { <span class="tv-last-updated">Updated: {{ date | date:'shortTime' }}</span> } 
    </div>
  </div>
  @if (store.isLoading()) { <mat-progress-bar mode="indeterminate" color="accent" style="height: 4px"></mat-progress-bar> } 
} 

<!-- MAIN CONTENT WRAPPER: Sidenav Layout for Editor -->
<mat-sidenav-container class="dashboard-sidnav-container h-full" autosize>
  
  <!-- LEFT: Dashboard Grid Viewport -->
  <mat-sidenav-content 
    class="view-port overflow-y-auto" 
    [class.tv-view]="isTvMode()" 
  >
    <!-- Skeleton -->
    @if (store.isLoading() && !store.dashboard()) { 
      <div class="ghost-grid" data-testid="skeleton-grid">
        <div class="ghost-card h-2" style="grid-column: span 6"><app-skeleton-loader variant="metric"></app-skeleton-loader></div>
        <div class="ghost-card h-2" style="grid-column: span 6"><app-skeleton-loader variant="chart"></app-skeleton-loader></div>
      </div>
    } 

    <!-- Grid -->
    @if (store.dashboard()) { 
      <div 
        cdkDropList
        id="dashboard-grid" 
        [cdkDropListDisabled]="!store.isEditMode() || isTvMode()" 
        [cdkDropListOrientation]="'mixed'" 
        (cdkDropListDropped)="onDrop($event)" 
        class="dashboard-grid" 
      >
        @for (widget of store.sortedWidgets(); track widget.id) { 
          <div
            class="grid-item" 
            cdkDrag
            [cdkDragData]="widget" 
            [style.grid-column]="'span ' + getColSpan(widget)" 
            [style.grid-row]="'span ' + getRowSpan(widget)" 
            [class.item-draggable]="store.isEditMode() && !isTvMode()" 
            [attr.data-testid]="'widget-wrapper-' + widget.id" 
          >
            <div class="widget-content">
              <app-widget
                [widget]="widget" 
                class="h-full block" 
                (edit)="editWidget(widget)" 
                (delete)="confirmDeleteWidget(widget)" 
                (duplicate)="store.duplicateWidget(widget)" 
              ></app-widget>
            </div>
            <!-- Placeholders -->
            <div *cdkDragPlaceholder class="drag-placeholder"></div>
            @if (store.isEditMode() && !isTvMode()) { 
              <div class="resize-handle" (mousedown)="startResizing($event, widget)"></div>
            } 
          </div>
        } 
      </div>

      <!-- Use Empty State Component when no widgets exist -->
      @if (store.widgets().length === 0) { 
        <app-empty-state class="h-full block"></app-empty-state>
      } 
    } 
  </mat-sidenav-content>

  <!-- RIGHT: Edit Sidebar (Gallery) -->
  <!-- Automatically opens in Edit Mode unless TV mode is on -->
  <mat-sidenav 
    mode="side" 
    position="end" 
    [opened]="store.isEditMode() && !isTvMode()" 
    class="editor-sidenav" 
    class="mat-elevation-z4" 
  >
    <app-widget-gallery class="h-full"></app-widget-gallery>
  </mat-sidenav>

</mat-sidenav-container>

<!-- Focus Overlay -->
@if (store.focusedWidget(); as focused) { 
  <div class="focus-overlay" role="dialog" aria-modal="true" (click)="store.setFocusedWidget(null)">
    <div class="focus-container" (click)="$event.stopPropagation()">
       <app-widget
         [widget]="focused" 
         class="h-full block" 
         (edit)="editWidget(focused)" 
         (delete)="confirmDeleteWidget(focused)" 
       ></app-widget>
    </div>
  </div>
}