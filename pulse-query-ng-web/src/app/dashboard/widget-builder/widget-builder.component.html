<div class="h-full flex flex-col overflow-hidden" style="background-color: var(--sys-background)">
  <div class="flex items-center justify-between px-6 py-4 border-b flex-shrink-0 dialog-header">
    <h2 class="text-xl font-light m-0">Add Widget</h2>
    <button mat-icon-button (click)="cancel()" aria-label="Close dialog">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <mat-dialog-content class="flex-grow !p-0 overflow-hidden">
    <mat-stepper
      [linear]="true"
      #stepper
      class="h-full flex flex-col"
      style="background: transparent"
    >
      <!-- STEP 1: SOURCE SELECTION -->
      <mat-step [stepControl]="sourceForm" [completed]="!!draftWidgetId()">
        <ng-template matStepLabel>Select Source</ng-template>

        <div
          class="flex flex-col h-full overflow-hidden"
          style="background-color: var(--sys-background)"
        >
          <mat-tab-group class="flex-grow" animationDuration="0ms" [(selectedIndex)]="selectedTab">
            <!-- TAB 1: MARKETPLACE -->
            <mat-tab label="Templates">
              <div class="p-6 h-full overflow-y-auto">
                <div class="flex gap-4 mb-4 items-center flex-wrap">
                  <mat-form-field
                    appearance="outline"
                    density="compact"
                    subscriptSizing="dynamic"
                    class="w-64"
                  >
                    <mat-icon matPrefix>search</mat-icon>
                    <input
                      matInput
                      placeholder="Search templates..."
                      (input)="updateSearch($event)"
                    />
                  </mat-form-field>
                  <!-- Chips automatically inherit theme inputs via global styles -->
                  <mat-chip-set>
                    @for (cat of categories(); track cat) {
                      <mat-chip-option
                        [selected]="selectedCategory() === cat"
                        (selectionChange)="toggleCategory(cat)"
                        >{{ cat }}</mat-chip-option
                      >
                    }
                  </mat-chip-set>
                </div>

                @if (loadingTemplates()) {
                  <div class="flex justify-center p-12">
                    <mat-spinner diameter="40"></mat-spinner>
                  </div>
                }

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" role="list">
                  @for (t of templates(); track t.id) {
                    <div
                      class="template-card"
                      [class.selected]="selectedTemplateId() === t.id"
                      (click)="selectTemplate(t)"
                      (keydown.enter)="selectTemplate(t)"
                      tabindex="0"
                      role="button"
                      [attr.aria-label]="'Select template: ' + t.title"
                    >
                      <div class="font-medium text-primary mb-1" style="color: var(--sys-primary)">
                        {{ t.title }}
                      </div>
                      <div
                        class="text-xs uppercase tracking-wider mb-2"
                        style="color: var(--sys-text-secondary)"
                      >
                        {{ t.category }}
                      </div>
                      <div
                        class="text-sm line-clamp-3"
                        style="color: var(--sys-on-surface-variant)"
                      >
                        {{ t.description }}
                      </div>
                    </div>
                  }
                </div>
              </div>
            </mat-tab>

            <!-- TAB 2: CUSTOM -->
            <mat-tab label="Custom Query">
              <div class="p-8 max-w-4xl mx-auto h-full flex flex-col justify-center">
                <h3
                  class="text-lg font-medium mb-6 text-center"
                  style="color: var(--sys-text-primary)"
                >
                  Choose Data Source
                </h3>
                <div class="grid grid-cols-3 gap-6">
                  <!-- SQL -->
                  <div
                    class="source-option"
                    [class.selected]="selectedCustomType() === 'SQL'"
                    (click)="selectCustomType('SQL')"
                    tabindex="0"
                    (keydown.enter)="selectCustomType('SQL')"
                  >
                    <mat-icon class="text-4xl mb-4" style="color: var(--sys-primary)"
                      >storage</mat-icon
                    >
                    <div class="font-bold">SQL Database</div>
                    <div class="text-sm mt-2 text-center" style="color: var(--sys-text-secondary)">
                      Query the internal DuckDB analytics engine using SQL
                    </div>
                  </div>
                  <!-- HTTP -->
                  <div
                    class="source-option"
                    [class.selected]="selectedCustomType() === 'HTTP'"
                    (click)="selectCustomType('HTTP')"
                    tabindex="0"
                    (keydown.enter)="selectCustomType('HTTP')"
                  >
                    <mat-icon class="text-4xl mb-4" style="color: var(--sys-tertiary)"
                      >cloud_download</mat-icon
                    >
                    <div class="font-bold">HTTP API</div>
                    <div class="text-sm mt-2 text-center" style="color: var(--sys-text-secondary)">
                      Fetch JSON data from an external REST endpoint
                    </div>
                  </div>
                  <!-- TEXT -->
                  <div
                    class="source-option"
                    [class.selected]="selectedCustomType() === 'TEXT'"
                    (click)="selectCustomType('TEXT')"
                    tabindex="0"
                    (keydown.enter)="selectCustomType('TEXT')"
                  >
                    <mat-icon class="text-4xl mb-4" style="color: var(--sys-secondary)"
                      >description</mat-icon
                    >
                    <div class="font-bold">Static Markdown</div>
                    <div class="text-sm mt-2 text-center" style="color: var(--sys-text-secondary)">
                      Add text descriptions, instructions, or notes.
                    </div>
                  </div>
                </div>
              </div>
            </mat-tab>
          </mat-tab-group>

          <!-- Footer -->
          <div
            class="p-4 border-t flex justify-end gap-2"
            style="background-color: var(--sys-surface); border-color: var(--sys-surface-border)"
          >
            <button mat-button (click)="cancel()">Cancel</button>
            <button
              mat-flat-button
              color="primary"
              (click)="initializeDraft(stepper)"
              [disabled]="isBusy() || (!selectedTemplateId() && !selectedCustomType())"
            >
              @if (isBusy()) {
                <mat-spinner diameter="18" class="mr-2"></mat-spinner>
              }
              Next: Configure
            </button>
          </div>
        </div>
      </mat-step>

      <!-- STEP 2 & 3: Configure & Visualize (Use consistent transparent background to let host control it) -->
      <mat-step [completed]="dataConfigured()">
        <ng-template matStepLabel>Configure Data</ng-template>
        @if (draftWidget(); as widget) {
          <div class="h-full flex flex-col overflow-hidden">
            <!-- EDITOR -->
            <div class="flex-grow overflow-hidden relative">
              @if (selectedType() === 'SQL') {
                <app-sql-builder
                  [dashboardId]="data.dashboardId"
                  [widgetId]="widget.id"
                  [initialSql]="widget.config['query']"
                  (sqlChange)="onSqlChange($event)"
                  class="h-full block"
                ></app-sql-builder>
              } @else if (selectedType() === 'HTTP') {
                <app-http-config
                  [dashboardId]="data.dashboardId"
                  [widgetId]="widget.id"
                  [initialConfig]="widget.config"
                  (configChange)="onConfigChange($event)"
                  class="h-full block"
                ></app-http-config>
              } @else if (selectedType() === 'TEXT') {
                <app-text-editor
                  [dashboardId]="data.dashboardId"
                  [widgetId]="widget.id"
                  [initialContent]="widget.config['content']"
                  (contentChange)="onContentChange($event)"
                  class="h-full block"
                ></app-text-editor>
              }
            </div>

            <!-- FOOTER -->
            <div
              class="p-4 border-t flex justify-end gap-2 z-10 relative"
              style="background: var(--sys-surface); border-color: var(--sys-surface-border)"
            >
              <button mat-button matStepperPrevious>Back</button>
              @if (activeMode() === 'template') {
                <button
                  mat-flat-button
                  color="primary"
                  (click)="runTemplateQuery(stepper)"
                  [disabled]="!templateFormValid() || isBusy()"
                >
                  @if (isBusy()) {
                    <mat-spinner diameter="18" class="mr-2"></mat-spinner>
                  }
                  Run & Preview
                </button>
              } @else if (widget.type === 'TEXT') {
                <button mat-flat-button color="primary" (click)="saveAndClose()">
                  Save & Finish
                </button>
              } @else {
                <button mat-flat-button color="primary" (click)="validateDataPresence(stepper)">
                  Next: Visualize
                </button>
              }
            </div>
          </div>
        }
      </mat-step>

      <mat-step>
        <ng-template matStepLabel>Visualize</ng-template>
        <!-- Visualize Step layout adjustments for themes -->
        <div class="h-full flex flex-col lg:flex-row overflow-hidden">
          <div
            class="w-full lg:w-80 border-r flex flex-col overflow-y-auto p-4 flex-shrink-0"
            style="background: var(--sys-surface-variant); border-color: var(--sys-surface-border)"
          >
            <h4 class="text-xs font-bold uppercase text-gray-500 mb-4">Settings</h4>

            <mat-form-field appearance="outline" subscriptSizing="dynamic" class="mb-4">
              <mat-label>Widget Title</mat-label>
              <input matInput [formControl]="titleControl" />
            </mat-form-field>

            <div class="text-xs font-bold uppercase text-gray-500 mb-2">Visualization Type</div>
            <mat-chip-listbox class="mb-4 flex-col" [selectable]="true">
              @for (viz of visualizations; track viz.id) {
                <mat-chip-option
                  [selected]="draftWidget()?.visualization === viz.id"
                  (click)="updateVizType(viz.id)"
                  class="w-full"
                >
                  <mat-icon>{{ viz.icon }}</mat-icon> {{ viz.label }}
                </mat-chip-option>
              }
            </mat-chip-listbox>

            @if (showAxesConfig()) {
              <mat-divider class="mb-4"></mat-divider>
              <mat-form-field appearance="outline" subscriptSizing="dynamic" class="mb-2">
                <mat-label>{{ isPie() ? 'Label Column' : 'X-Axis / Category' }}</mat-label>
                <mat-select [formControl]="xKeyControl">
                  <mat-option [value]="null">Auto</mat-option>
                  @for (col of availableColumns(); track col) {
                    <mat-option [value]="col">{{ col }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>

              <mat-form-field appearance="outline" subscriptSizing="dynamic">
                <mat-label>{{ isPie() ? 'Size Column' : 'Y-Axis / Value' }}</mat-label>
                <mat-select [formControl]="yKeyControl">
                  <mat-option [value]="null">Auto</mat-option>
                  @for (col of availableColumns(); track col) {
                    <mat-option [value]="col">{{ col }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>
            }
          </div>
          <div
            class="flex-grow flex flex-col p-8 overflow-hidden relative"
            style="background: var(--sys-background)"
          >
            <div
              class="bg-white rounded-lg shadow-sm border h-full w-full overflow-hidden flex flex-col p-4"
              style="background-color: var(--sys-surface); border-color: var(--sys-surface-border)"
            >
              @if (draftWidget(); as w) {
                <app-widget [widget]="w" class="flex-grow h-full w-full"></app-widget>
              }
            </div>
          </div>
        </div>
        <div
          class="p-4 border-t flex justify-end gap-2 fixed-bottom"
          style="background: var(--sys-surface); border-color: var(--sys-surface-border)"
        >
          <button mat-button matStepperPrevious>Back</button>
          <button
            mat-flat-button
            color="primary"
            (click)="saveAndClose()"
            [disabled]="titleControl.invalid || isBusy()"
          >
            @if (isBusy()) {
              <mat-spinner diameter="18" class="mr-2"></mat-spinner>
            }
            Save Widget
          </button>
        </div>
      </mat-step>
    </mat-stepper>
  </mat-dialog-content>
</div>
